<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Wellcome to FMS</title>
    <link rel="stylesheet" href="assets/layui/css/layui.css">
    <link rel="stylesheet" href="assets/common.css">
    <link rel="shorcut icon" href="assets/images/logo.png">
</head>

<body>
<div class="layui-container" style="padding-top: 15px;width:100%">
    <div class="layui-card">
        <div class="layui-card-header">当前位置：<span id="tvFP">/</span></div>
        <div class="layui-card-body layui-form">
            <div class="layui-form-item layui-row">
            <div class="btnDiv layui-col-md9">
                <button id="btnBack" class="layui-btn layui-btn-sm layui-btn-primary icon-btn"><i class="layui-icon">&#xe65c;</i>返回上级
                </button>
                <button id="btnRefresh" class="layui-btn layui-btn-sm layui-btn-primary icon-btn"><i class="layui-icon">&#xe669;</i>刷新
                </button>
                <button id="btnAdd" type="button" class="layui-btn layui-btn-sm layui-btn-normal icon-btn"><i class="layui-icon">&#xe681;</i>填写文件信息
                </button>
                <button id="btnNewDir" class="layui-btn layui-btn-sm layui-btn-normal icon-btn"><i class="layui-icon layui-icon-add-circle"></i>新建文件夹
                </button>
                <button id="btnDelDir" class="layui-btn layui-btn-sm layui-btn-primary icon-btn"><i class="layui-icon layui-icon-delete"></i>刪除目录
                </button>
                <button id="btnRname" class="layui-btn layui-btn-sm layui-btn-primary icon-btn"><i class="layui-icon layui-icon-edit"></i>重命名目录
                </button>
            </div>
            </div>
            <div class="file-list"></div>
        </div>
    </div>
</div>
<!--<div style="text-align: center;margin: 60px 0 20px 0">-->
<!--    <a style="color: #777;" href="https://xinke.org.cn" target="_blank">ECode1024</a> |-->
<!--</div>-->

<!-- 下拉菜单 -->
<div class="dropdown-menu dropdown-anchor-top-left" id="dropdownFile">
    <div class="dropdown-anchor"></div>
    <ul>
        <li><a id="open"><i class="layui-icon layui-icon-file"></i>&emsp;查看&emsp;</a></li>
        <li><a id="down"><i class="layui-icon layui-icon-download-circle"></i>&emsp;下载&emsp;</a></li>
        <li>
            <a id="del" style="color: red !important;">
                <i class="layui-icon layui-icon-delete" style="font-size: 19px;"></i>&nbsp;&nbsp;&nbsp;删除&emsp;
            </a>
        </li>
        <li><a id="share"><i class="layui-icon layui-icon-share"></i>&emsp;分享&emsp;</a></li>
        <li><a id="rename"><i class="layui-icon layui-icon-edit"></i>&emsp;重命名&emsp;</a></li>
        <li><a id="attribute"><i class="layui-icon layui-icon-about"></i>&emsp;属性&emsp;</a></li>
    </ul>
</div>

<input type="hidden" id="shareFileUrl" value="">
<!-- 渲染模板 -->
<script id="fileTpl" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="file-list-item" data-dir="{{item.isDir}}" data-url="{{item.url}}" data-name="{{item.name}}" data-preview="{{item.preview}}">
        <div class="file-list-img {{item.hasSm?'media':''}}">
            {{# if(item.hasSm){ }}
            <img src="{{item.smUrl}}"/>
            {{# }else{ }}
            <img src="assets/images/fti/{{item.type}}.png"/>
            {{# } }}
        </div>
        <div class="file-list-name">{{item.name}}</div>
    </div>
    {{#  }); }}
    {{# if(d.length<=0){ }}
    <div class="list-empty">
        <i class="layui-icon layui-icon-face-surprised"></i>
        <div>没有文件</div>
    </div>
    {{# } }}
</script>

<script type="text/javascript" src="assets/layui/layui.js"></script>
<script type="text/javascript" src="assets/clipboard.min.js"></script>
<script type="text/javascript" src="assets/config.js"></script>
<script>
    layui.use(['jquery', 'layer', 'element', 'upload', 'laytpl', 'util','form'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var element = layui.element;
        var upload = layui.upload;
        var laytpl = layui.laytpl;
        var util = layui.util;
        var form = layui.form;

        // 渲染文件列表
        function renderList(dir) {
            if ($('#tvFP').text() == '/') {
                $('#btnAdd').hide();
                $('#btnDelDir').hide();
                $('#btnRname').hide();

            } else {
                $('#btnAdd').show();
                $('#btnDelDir').show();
                $('#btnRname').show();
            }
            if (!dir) {
                dir = $('#tvFP').text();
            }
            layer.load(2);
            $.get(baseServer + 'api/list', {
                dir: dir
            }, function (res) {
                layer.closeAll('loading');
                if (res.code == 200) {
                    for (var i = 0; i < res.data.length; i++) {
                        res.data[i].url = baseServer + 'file/' + res.data[i].url;
                        res.data[i].smUrl = baseServer + 'file/sm?p=' + res.data[i].smUrl;
                    }
                    laytpl(fileTpl.innerHTML).render(res.data, function (html) {
                        $('.file-list').html(html);
                    });
                } else {
                    layer.msg(res.msg, {icon: 2});
                }
            });
        }

        renderList();

        //输入上传信息
        $("#btnAdd").click(function () {
                layer.open({
                    type: 1,
                    title:"文件信息",
                    skin: 'layui-layer-rim', //加上边框
                    area: ['800px', '800px'], //宽高
                    content:'<br/>\n' +
            '<div class="layui-form">\n' +
            '    <form class="layui-form form-container">\n' +
            '        <div class="layui-form-item">\n' +
            '            <label class="layui-form-label">试验名称</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="faultName" value="" lay-verify="required" placeholder="请输入名称" class="layui-input" id="faultName">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item">\n' +
            '            <label class="layui-form-label">试验类型</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="testType" value="" lay-verify="required" placeholder="请输入试验类型" class="layui-input" id="testType">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item">\n' +
            '            <label class="layui-form-label">试验人员</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="member" value="" lay-verify="required" placeholder="请输入试验人员" class="layui-input" id="member">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item">\n' +
            '            <label class="layui-form-label">试验装置</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="device" value="" lay-verify="required" placeholder="请输入试验装置" class="layui-input" id="device">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item layui-form-text">\n' +
            '            <label class="layui-form-label">试验程度</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                 <input type="text"  name="degree" value="" lay-verify="required" placeholder="请输入内容" class="layui-input" id="degree">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item layui-form-text">\n' +
            '            <div style="margin-left:40px">试验工况：</div>\n' +
            '            <label class="layui-form-label" >温度</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="temperature" value="" lay-verify="required" placeholder="请输入温度" class="layui-input" id="temperature">\n' +
            '            </div>\n' +
            '                <br/>\n' +
            '            <label class="layui-form-label" >压力</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="pressure" value="" lay-verify="required" placeholder="请输入压力" class="layui-input" id="pressure">\n' +
            '            </div>\n' +
            '                <br/>\n' +
            '            <label class="layui-form-label" >流量</label>\n' +
            '            <div class="layui-input-block">\n' +
            '                <input type="text" name="traffic" value="" lay-verify="required" placeholder="请输入流量" class="layui-input" id="traffic">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '\n' +
            '        <div class="layui-form-item layui-form-text">\n' +
            '            <div class="layui-input-block">\n' +
            '                <br/>\n' +
            '                <div id="filename" style="width:400px;height: 50px;overflow:auto" ></div>\n' +
            '                <button type="button" class="layui-btn " id="verifyButton">\n' +
            '                    <i class="layui-icon">&#xe67c;</i>上传文件\n' +
            '                </button>\n' +
            '                <button type="button" class="layui-btn upload-btn-whole" style="display: none" id="upload">\n' +
            '                   真实的上传文件\n' +
            '                </button>\n' +
            '            </div>\n' +
            '        </div>\n' +
            '        <div class="layui-form-item">\n' +
            '            <div class="layui-input-block">\n' +
            '                <button class="layui-btn" lay-submit  lay-filter="formFile" id="submitfile1">提交</button>\n' +
            '                <button  class="layui-btn layui-btn-primary" id="submitfile" style="display: none">真实的提交</button>\n' +
            '                <button type="reset" class="layui-btn layui-btn-primary" id="resetfile">重置</button>\n' +
            '            </div>\n' +
            '        </div>\n' +
            '    </form>\n' +
            '</div>', //调到文件信息页面
                    success: function(){
                        upload.render({
                            elem: '.upload-btn-whole', //绑定元素
                            shade:false,
                            accept: 'file', //允许上传的文件类型
                            multiple: true, //允许多文件上传
                            auto: false, //选完文件后不要自动上传
                            bindAction: '#submitfile', //指定一个按钮触发上传
                            // number:3,
                            url: baseServer + 'file/upload', //上传接口
                            before:function(obj){
                                        // 动态传参
                                this.data.curPos = $('#tvFP').text();
                                this.data.faultName = $('input[name="faultName"]').val();
                                this.data.testType = $('input[name="testType"]').val();
                                this.data.device = $('input[name="device"]').val();
                                this.data.member = $('input[name="member"]').val();
                                this.data.degree = $('input[name="degree"]').val();
                                this.data.temperature = $('input[name="temperature"]').val();
                                this.data.pressure = $('input[name="pressure"]').val();
                                this.data.traffic = $('input[name="traffic"]').val();
                            },
                            choose: function (obj) {
                                // let files = obj.pushFile(); //将每次选择的文件追加到文件队列
                                // console.log(files);
                                document.getElementById("filename").innerHTML = "";
                                obj.preview(function(index, file, result){
                                    let _name =document.createElement('_name');
                                    _name.innerHTML=file.name+"<br/>";
                                    document.getElementById("filename").appendChild(_name); //添加到预览区域
                                });
                            },
                            done: function (res, index, upload) {
                                layer.closeAll("loading");
                                if (res.code != 200) {
                                    layer.msg(res.msg, {icon: 2});
                                } else {
                                    layer.msg(res.msg, {icon: 1});
                                    renderList();
                                    // layer.closeAll();
                                }
                            },
                            error: function () {
                                layer.closeAll("loading");
                                layer.msg('上传失败', {icon: 2});
                            },
                        })
                    }
                });
                //重置
                $("#resetfile").click(function () {
                    document.getElementById("filename").innerHTML="";
                });
                //必须验证上传列表中有值才能被点击
                $("#submitfile1").click(function(){
                        let val = document.getElementById("filename").innerHTML;
                        if(val){
                            document.getElementById("submitfile").click();
                        }else{
                            layer.msg('请上传文件', {icon: 2})
                        };
                        return false;
                    });
                //表单验证
                // function verify(){
                //     let _FaultName = document.getElementById("faultName").value;
                //     let _TestType = document.getElementById("testType").value;
                //     let _person = document.getElementById("member").value;
                //     let _device = document.getElementById("device").value;
                //     let _temperature = document.getElementById("temperature").value;
                //     let _pressure = document.getElementById("pressure").value;
                //     let _traffic = document.getElementById("traffic").value;
                //     let _inner = document.getElementById("filename").innerHTML;
                //     switch (true){
                //         case _FaultName=="": layer.msg('请输入试验名称', {icon: 2});return false;
                //         case _TestType=="": layer.msg('请输入试验类型', {icon: 2});return false;
                //         case _person=="": layer.msg('请输入试验人员', {icon: 2});return false;
                //         case _device=="": layer.msg('请输入试验装置', {icon: 2});return false;
                //         case _temperature=="": layer.msg('请输入温度', {icon: 2});return false;
                //         case _pressure=="": layer.msg('请输入压力', {icon: 2});return false;
                //         case _traffic=="": layer.msg('请输入流量', {icon: 2});return false;
                //     };
                //     return true;
                // };
               //必填项验证后才可点击上传文件按钮
                $("#verifyButton").click(function (){
                    // let result = verify();
                    // if(result){
                        document.getElementById("upload").click();
                    // }

                });
                //重置之后依然可提交
                $("#")
        })

        // 刷新
        $('#btnRefresh').click(function () {
            renderList();
        });

        var mUrl;
        // 列表点击事件
        $('body').on('click', '.file-list-item', function (e) {
            var isDir = $(this).data('dir');
            var name = $(this).data('name');
            var preview = $(this).data('preview');
            mUrl = $(this).data('url');
            $('#copy').attr('data-clipboard-text', mUrl);
            if (isDir) {
                var cDir = $('#tvFP').text();
                cDir += (cDir == '/' ? name : ('/' + name));
                $('#tvFP').text(cDir);
                renderList(cDir);
            } else {
                var $target = $(this).find('.file-list-img');
                $('#dropdownFile').css({
                    'top': $target.offset().top + 90,
                    'left': $target.offset().left + 25
                });
                $('#dropdownFile').addClass('dropdown-opened');
                if (!preview) {
                    $('#open').hide();
                } else {
                    $('#open').show();
                }
                if (e !== void 0) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });

        // 返回上级
        $('#btnBack').click(function () {
            var cDir = $('#tvFP').text();
            if (cDir == '/') {
                layer.msg('已经是根目录')
            } else {
                cDir = cDir.substring(0, cDir.lastIndexOf('/'));
                if (!cDir) {
                    cDir = '/';
                }
                $('#tvFP').text(cDir);
                renderList(cDir);
            }
        });

        // 点击空白隐藏下拉框
        $('html').off('click.dropdown').on('click.dropdown', function () {
            $('#copy').attr('data-clipboard-text', '');
            $('#dropdownFile').removeClass('dropdown-opened');
        });

        // 查看
        $('#open').click(function () {
            var fullName = mUrl.substr(7);
            window.open("/file?p=" + fullName + "&d=0", '_blank');
        });

        // 下载
        $('#down').click(function () {
            var fullName = mUrl.substr(7);
            window.open("/file?p=" + fullName + "&d=1", '_blank');
        });

        // 删除
        $('#del').click(function () {
            layer.confirm('确定要删除此文件吗？', function () {
                layer.load(2);
                $.get(baseServer + 'api/del', {
                    file: mUrl.substring(mUrl.indexOf('/file/') + 6)
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.msg(res.msg, {icon: 1});
                        renderList();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
            });
        });

        // 重命名
        $('#rename').click(function () {
            layer.prompt({
                formType: 0,
                value: mUrl.substr(mUrl.lastIndexOf('/') + 1),
                title: '新文件名'
            }, function(value, index, elem){
                var oldFile = mUrl.substring(mUrl.indexOf('/file/') + 6);
                var newFile = mUrl.substr(7, mUrl.lastIndexOf('/') - 6) + value;
                layer.load(2);
                $.get(baseServer + 'api/rename', {
                    oldFile: oldFile,
                    newFile: newFile
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.msg(res.msg, {icon: 1});
                        renderList();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });

        // 分享
        $('#share').click(function () {
            layer.prompt({
                formType: 0,
                value: '30',
                title: '设置时间(分钟)'
            }, function(value, index, elem){
                var file = mUrl.substr(7);
                layer.load(2);
                $.post(baseServer + 'api/share', {
                    file: file,
                    time: value
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.open({
                            title: res.msg,
                            content: '链接：' + res.url,
                            btn: ['复制链接'],
                            btn1: function(index, layero){
                                var clipboard = new ClipboardJS(".layui-layer-btn0",{
                                    text: function () {
                                        return res.url;
                                    }
                                });
                                clipboard.on('success', function (e) {
                                    e.clearSelection();
                                    layer.msg('分享地址已复制', {icon: 1});
                                });
                                clipboard.on('error', function (e) {
                                    layer.msg('复制失败，请手动复制', {icon: 2});
                                });
                            }
                        });
                    }
                });
                layer.close(index);
            });
        });

        // 选择删除
        $('#btnSelectDel').click(function () {
            layer.open({
                type: 2,
                title: '选择文件',
                content: 'fileChoose.html?multi=true',
                area: ['600px', '420px'],
                offset: '50px',
                shade: .1,
                fixed: false,
                resize: true,
                end: function () {
                    if (typeof(mFsUrls) != "undefined" && mFsUrls.length > 0) {
                        layer.msg('你选择了：' + JSON.stringify(mFsUrls), {icon: 1});
                        mFsUrls = undefined;
                    }
                }
            });
        });

        // 新建文件夹
        $('#btnNewDir').click(function () {
            layer.prompt({
                formType: 0,
                value: "新建文件夹",
                title: '文件名'
            }, function(value, index, elem){
                var curPos = $('#tvFP').text();
                layer.load(2);
                $.get(baseServer + 'api/mkdir', {
                    curPos: curPos,
                    dirName: value
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.msg(res.msg, {icon: 1});
                        renderList();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });

        // 删除当前目录
        $('#btnDelDir').click(function () {

            layer.confirm('将删除此目录下所有文件', {icon: 3, title:'确认'}, function(index){
                var curPos = $('#tvFP').text().substr(1);
                layer.load(2);
                $.get(baseServer + 'api/del', {
                    file: curPos
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.msg(res.msg, {icon: 1});
                        renderList();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });

        // 重命名当前目录
        $('#btnRname').click(function () {
            var tvFP = $('#tvFP').text();
            layer.prompt({
                formType: 0,
                value: tvFP,
                title: '新目录名'
            }, function(value, index, elem){
                layer.load(2);
                $.get(baseServer + 'api/rename', {
                    oldFile: tvFP.substr(1),
                    newFile: value.substr(1)
                }, function (res) {
                    layer.closeAll('loading');
                    if (res.code == 200) {
                        layer.msg(res.msg, {icon: 1});
                        $('#tvFP').text(res.url);
                        renderList();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });
      //搜索模糊查询

    });
</script>
</body>
</html>